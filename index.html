<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å²¡è¯ç‰§å ´æŠ“ç‰›å¤§è³½</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: "Microsoft JhengHei", sans-serif; touch-action: none; }
        canvas { display: block; }
        #ranch-story {
            position: absolute; top: 15px; left: 15px; width: 65%;
            color: white; font-size: 13px; line-height: 1.5;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8); pointer-events: none; z-index: 5;
        }
        #ui { position: absolute; top: 15px; right: 15px; color: white; text-shadow: 2px 2px 4px #000; font-size: 20px; z-index: 10; text-align: right; }
        #msg-container { 
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; display: none; width: 90%; z-index: 20; 
        }
        #msg { color: #FFD700; font-size: 32px; font-weight: bold; text-shadow: 3px 3px 0 #000; margin-bottom: 20px; }
        .game-btn { 
            background: linear-gradient(#FFB74D, #FF9800); color: white; border: none; padding: 12px 30px; 
            font-size: 20px; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #E65100; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="ranch-story">
    <b>å²¡è¯ç‰§å ´</b><br>
    å‰µç«‹æ–¼æ°‘åœ‹59å¹´ï¼Œå¾å…©é ­ä¹³ç‰›èµ·å®¶ï¼Œç¶“ç‡Ÿ55å¹´é£¼é¤Šç´„300éš»ä¹³ç‰›ã€‚
    æ°‘åœ‹94å¹´æˆç«‹é®®ä¹³é–€å¸‚ï¼Œæä¾›ç²¾é¸é®®ä¹³è£½å“ï¼Œé«”é©—é…ªè¾²çœŸå¯¦ç”Ÿæ´»ã€‚
</div>

<div id="ui">
    ğŸ† é—œå¡: <span id="lv">1</span> / 6 <br>
    ğŸ’° åˆ†æ•¸: <span id="score">0</span>
</div>

<div id="msg-container">
    <div id="msg"></div>
    <button id="actionBtn" class="game-btn" onclick="handleBtnClick()"></button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lvDisp = document.getElementById('lv'), scoreDisp = document.getElementById('score');
const msgContainer = document.getElementById('msg-container'), msgDisp = document.getElementById('msg');
const actionBtn = document.getElementById('actionBtn');

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

const rawBase = `https://raw.githubusercontent.com/cposram/cow/main/`;
const imgAssets = {
    bg: new Image(), lasso: new Image(), cowNormal: new Image(), 
    cowGold: new Image(), cowDiamond: new Image(), cowGalaxy: new Image(), 
    cowLegendary: new Image(), hero: new Image()
};

imgAssets.bg.src = rawBase + 'game_bg.png'; 
imgAssets.lasso.src = rawBase + 'lasso_loop.png';
imgAssets.cowNormal.src = rawBase + 'cow_normal.png';
imgAssets.cowGold.src = rawBase + 'cow_gold.png';
imgAssets.cowDiamond.src = rawBase + 'cow_diamond.png';
imgAssets.cowGalaxy.src = rawBase + 'cow_galaxy.png';
imgAssets.cowLegendary.src = rawBase + 'cow_legendary.png';
imgAssets.hero.src = rawBase + 'cowboy_hero.png';

let level = 1, score = 0, gameState = 'RUNNING', pullProgress = 0, frameCount = 0;
let lasso = { y: 0, active: false, speed: 35 };

class Cow {
    constructor(lv) {
        this.lv = lv;
        const imgs = [imgAssets.cowNormal, imgAssets.cowNormal, imgAssets.cowGold, imgAssets.cowDiamond, imgAssets.cowGalaxy, imgAssets.cowLegendary];
        this.img = imgs[lv-1] || imgs[0];
        // ç‚ºäº†é…åˆé è·é›¢ï¼Œç¨å¾®èª¿æ•´ç‰›çš„å¤§å°ï¼Œè®“å®ƒåœ¨é è™•çœ‹èµ·ä¾†æ¯”ä¾‹æ­£å¸¸
        this.baseWidth = 130 + (lv * 18);
        this.width = this.baseWidth; 
        this.height = this.width * 0.75;
        this.x = -250; 
        this.y = canvas.height * 0.8 - this.height;
        this.speed = (4 + lv * 1.4);
        this.strugglePower = 0.3 + (lv * 0.08); 
    }
    update() {
        if (gameState === 'RUNNING') {
            this.x += this.speed;
            this.width = this.baseWidth; // è·‘å‹•æ™‚ç¶­æŒåŸå¤§å°
            this.height = this.width * 0.75;
        }
        else if (gameState === 'CATCHING') {
            // ã€ä¿®æ”¹é»1ï¼šå¢åŠ è·é›¢èˆ‡å¼µåŠ›ã€‘
            // åŸºç¤è·é›¢è¨­ç‚º canvas.width/2 + 120 (æ¯”åŸä¾†æ›´é )
            // å‹•æ…‹è·é›¢ï¼š(100 - pullProgress) * 3.5 -> ç•¶é€²åº¦ä½æ™‚ï¼Œç‰›æœƒé€€å¾—éå¸¸é ï¼Œç¹©å­æ‹‰å¾ˆé•·
            const targetX = (canvas.width/2 + 120) + (100 - pullProgress) * 3.5;
            
            // ä½¿ç”¨è¼ƒå¹³æ»‘çš„ç§»å‹•ä¿‚æ•¸ 0.08ï¼Œè®“æ‹‰æ‰¯æ„Ÿæœ‰å½ˆæ€§
            this.x += (targetX - this.x) * 0.08;
            
            // è¦–è¦ºé€è¦–ï¼šç¨å¾®ç¸®å°ä¸€é»é»ç‰›ï¼Œå› ç‚ºå®ƒè¢«æ‹‰é äº† (95%å¤§å°)
            this.width = this.baseWidth * 0.95; 
            this.height = this.width * 0.75;
        }
    }
    draw() { if (this.img.complete) ctx.drawImage(this.img, this.x, this.y, this.width, this.height); }
}

let currentCow = new Cow(1);

function initLevel(nextLevel) {
    level = nextLevel; lvDisp.innerText = level;
    currentCow = new Cow(level); gameState = 'RUNNING';
    msgContainer.style.display = 'none'; resetLasso();
}

function resetLasso() { lasso.active = false; lasso.y = canvas.height - 120; }

function drawBG() {
    if (imgAssets.bg.complete && imgAssets.bg.naturalWidth !== 0) {
        const scale = canvas.width / imgAssets.bg.naturalWidth;
        const h = imgAssets.bg.naturalHeight * scale;
        ctx.drawImage(imgAssets.bg, 0, 0, canvas.width, h);
        if (h < canvas.height) {
            ctx.fillStyle = "#4CAF50"; 
            ctx.fillRect(0, h-2, canvas.width, canvas.height - h + 2);
        }
    } else {
        ctx.fillStyle = '#87CEEB'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
}

function gameLoop() {
    frameCount++;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (gameState === 'VICTORY') {
        drawVictoryScene();
    } else {
        drawBG();
        if (imgAssets.hero.complete) ctx.drawImage(imgAssets.hero, canvas.width/2 - 60, canvas.height - 180, 120, 150);
        currentCow.update(); currentCow.draw();
        
        if (currentCow.x > canvas.width + 300) currentCow = new Cow(level);
        
        if (lasso.active && gameState === 'RUNNING') {
            lasso.y -= lasso.speed;
            if (imgAssets.lasso.complete) ctx.drawImage(imgAssets.lasso, canvas.width/2-45, lasso.y-45, 90, 90);
            
            // åˆ¤å®šç¯„åœç¨å¾®æ”¾å¯¬ï¼Œæ¯”è¼ƒå¥½æŠ“
            let cowCenterX = currentCow.x + currentCow.width/2;
            let cowCenterY = currentCow.y + currentCow.height/2;
            
            if (Math.abs(lasso.y - cowCenterY) < 70 && Math.abs(canvas.width/2 - cowCenterX) < 80) {
                gameState = 'CATCHING'; pullProgress = 50;
            }
            if (lasso.y < -50) resetLasso();
        }
        
        if (gameState === 'CATCHING') {
            pullProgress -= currentCow.strugglePower;
            
            // ç•«ç¹©ç´¢ï¼šåŠ ä¸Šä¸€é»é»éš¨æ©ŸæŠ–å‹•ï¼Œæ¨¡æ“¬ç”¨åŠ›æ™‚çš„éœ‡å‹•
            let shake = (Math.random() - 0.5) * 2; 
            
            ctx.beginPath(); 
            // èµ·é»ï¼šä¸»è§’çš„æ‰‹
            ctx.moveTo(canvas.width/2, canvas.height-120);
            // çµ‚é»ï¼šç‰›çš„ä¸­å¿ƒ (å› ç‚ºç‰›è¢«æ¨é äº†ï¼Œç·šæœƒè‡ªå‹•è®Šé•·)
            ctx.lineTo(currentCow.x + currentCow.width/2 + shake, currentCow.y + currentCow.height/2 + shake);
            
            // ç·šæ¢æ¨£å¼ï¼šé¡è‰²åŠ æ·±ï¼Œæ ¹æ“šæ‹‰åŠ›æ”¹è®Šç²—ç´°
            ctx.strokeStyle = '#5D4037'; 
            ctx.lineWidth = 4 + (pullProgress/100)*2; // é€²åº¦è¶Šé«˜ç·šè¶Šç²—(ç©©)ï¼Œå¿«æ–·æ™‚è®Šç´°
            ctx.stroke();
            
            drawBar();
            if (pullProgress <= 0) failCatch();
            else if (pullProgress >= 100) successCatch();
        }
    }
    requestAnimationFrame(gameLoop);
}

// ã€ä¿®æ”¹é»2ï¼šæœ€çµ‚å‹åˆ©å¤§éŠè¡Œ - å…¨å“¡å…¥é¡ç‰ˆã€‘
function drawVictoryScene() {
    drawBG();
    // å™´ç™¼ç‰¹æ•ˆ
    for(let i=0; i<20; i++) {
        ctx.fillStyle = i % 3 === 0 ? 'gold' : (i%3===1 ? '#FFD700' : 'white');
        ctx.beginPath();
        let x = (frameCount*3 + i*80) % canvas.width;
        let y = (frameCount*2 + i*40) % canvas.height;
        ctx.arc(x, y, 6, 0, Math.PI*2);
        ctx.fill();
    }

    // è¨ˆç®—ç‰ˆé¢é…ç½®
    // è®“ä¸»è§’åœ¨æœ€å·¦é‚Š (ç•™ä¸€é»é‚Šè·)
    const paddingLeft = 20;
    const paddingRight = 20;
    
    // ä¸»è§’å°ºå¯¸
    const hW = 100, hH = 130; 
    const heroX = paddingLeft;
    const heroY = canvas.height * 0.82 - hH;

    if (imgAssets.hero.complete) ctx.drawImage(imgAssets.hero, heroX, heroY, hW, hH);

    const collectedCows = [imgAssets.cowNormal, imgAssets.cowNormal, imgAssets.cowGold, imgAssets.cowDiamond, imgAssets.cowGalaxy, imgAssets.cowLegendary];
    
    // è¨ˆç®—å‰©é¤˜å¯¬åº¦çµ¦6éš»ç‰›
    // èµ·é»æ˜¯ä¸»è§’å³å´ï¼Œçµ‚é»æ˜¯ç•«é¢å³å´æ‰£é™¤é‚Šè·
    const startX = heroX + hW - 30; // -30 è®“ç¬¬ä¸€éš»ç‰›ç¨å¾®ç–Šåœ¨ä¸»è§’å¾Œé¢
    const availableWidth = canvas.width - startX - paddingRight;
    
    // æ¯éš»ç‰›å¯ä»¥åˆ†é…åˆ°çš„ã€Œæ­¥é€²è·é›¢ã€
    // å¦‚æœè¢å¹•å¾ˆå¯¬ï¼Œè·é›¢å°±å¤§ï¼›è¢å¹•çª„ï¼Œè·é›¢å°±å°(é‡ç–Šå¤š)
    const stepX = availableWidth / collectedCows.length;

    // å¾ç¬¬ä¸€é ­åˆ°ç¬¬å…­é ­ç‰›
    collectedCows.forEach((img, i) => {
        if (!img.complete) return;
        
        // å‹•æ…‹è¨ˆç®—ç‰›çš„å°ºå¯¸ï¼šæ ¹æ“šè¢å¹•å¯¬åº¦å¾®èª¿ï¼Œé¿å…åœ¨æ‰‹æ©Ÿä¸Šéå¤§
        // åŸºç¤å¯¬åº¦ 90ï¼Œéš¨ç­‰ç´šè®Šå¤§ï¼Œä½†æœ‰ç”¨ Math.min é™åˆ¶æœ€å¤§å€¼
        let baseScale = Math.min(1.2, canvas.width / 450); 
        const cowW = (90 + (i * 10)) * baseScale;
        const cowH = cowW * 0.75;
        
        // ä½ç½®è¨ˆç®—
        const cowX = startX + (i * stepX);
        // ä¸Šä¸‹æµ®å‹•å‹•ç•«
        const cowY = canvas.height * 0.83 - cowH + Math.sin(frameCount*0.08 + i)*6;

        // ç•«ç‰½ç¹©
        ctx.beginPath();
        if (i === 0) {
            // ç¬¬ä¸€éš»é€£ä¸»è§’
            ctx.moveTo(heroX + hW * 0.8, heroY + hH * 0.6);
        } else {
            // å¾Œé¢çš„é€£å‰é¢çš„ç‰›å±è‚¡
            const prevCowX = startX + ((i-1) * stepX);
            const prevCowW = (90 + ((i-1) * 10)) * baseScale;
            const prevCowH = prevCowW * 0.75;
            const prevCowY = canvas.height * 0.83 - prevCowH + Math.sin(frameCount*0.08 + (i-1))*6;
            ctx.moveTo(prevCowX + prevCowW * 0.7, prevCowY + prevCowH * 0.6);
        }
        
        // é€£åˆ°ç•¶å‰ç‰›çš„è„–å­
        ctx.quadraticCurveTo(
            (cowX + (i===0?heroX:cowX-stepX))/2, cowY + 50, // æ§åˆ¶é»è®“ç¹©å­å‚ä¸€é»
            cowX + 10, cowY + cowH * 0.4
        );
        ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 2; ctx.stroke();

        ctx.drawImage(img, cowX, cowY, cowW, cowH);
    });
}

function drawBar() {
    const w = canvas.width * 0.7;
    ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(canvas.width/2 - w/2, 100, w, 20);
    ctx.fillStyle = pullProgress > 30 ? '#0f0' : '#f00';
    ctx.fillRect(canvas.width/2 - w/2, 100, (pullProgress/100)*w, 20);
}

function successCatch() {
    score += level * 100; scoreDisp.innerText = score;
    if (level < 6) { 
        gameState = 'SUCCESS'; showMsg("æˆåŠŸæ•ç²ï¼", ""); 
        setTimeout(() => initLevel(level+1), 1000); 
    } else { 
        gameState = 'VICTORY'; 
        showMsg("ğŸ‰ å‚³èªªé”æˆï¼<br>å¯¶è²ç‰›å…¨éƒ¨æ”¶è—æˆåŠŸï¼", "å†ç©ä¸€æ¬¡"); 
    }
}

function failCatch() { gameState = 'FAIL'; showMsg("é€ƒè·‘äº†...", "é‡è©¦"); }

function showMsg(t, b) { msgDisp.innerHTML = t; actionBtn.innerText = b; actionBtn.style.display = b ? "inline-block" : "none"; msgContainer.style.display = "block"; }

function handleBtnClick() { if (gameState === 'FAIL' || gameState === 'VICTORY') { score = 0; initLevel(1); } }

function handleInput(e) {
    if (e) e.preventDefault();
    if (gameState === 'RUNNING' && !lasso.active) lasso.active = true;
    else if (gameState === 'CATCHING') pullProgress += 15;
}

canvas.addEventListener('touchstart', handleInput, {passive: false});
window.addEventListener('mousedown', (e) => { if(e.button===0) handleInput(e); });
initLevel(1); gameLoop();
</script>
</body>
</html>
