<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á§æÂçÄÊäìÁâõÂ§ßË≥Ω - ÁµÇÊ•µ‰∫íÂãïÁâà</title>
    <style>
        body { margin: 0; overflow: hidden; background: #4CAF50; font-family: "Microsoft JhengHei", sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: env(safe-area-inset-top, 20px); left: 20px; color: white; text-shadow: 2px 2px 4px #000; font-size: 22px; pointer-events: none; z-index: 10; }
        #msg-container { 
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; display: none; width: 90%; z-index: 20; 
        }
        #msg { color: #FFD700; font-size: 36px; font-weight: bold; text-shadow: 3px 3px 0 #000; margin-bottom: 20px; }
        .game-btn { 
            background: #FF9800; color: white; border: none; padding: 12px 30px; 
            font-size: 20px; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 5px 0 #E65100; font-weight: bold;
        }
        .game-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #E65100; }
    </style>
</head>
<body>

<div id="ui">
    üèÜ ÈóúÂç°: <span id="lv">1</span> / 6 <br>
    üí∞ ÂàÜÊï∏: <span id="score">0</span>
</div>

<div id="msg-container">
    <div id="msg"></div>
    <button id="actionBtn" class="game-btn" onclick="handleBtnClick()"></button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lvDisp = document.getElementById('lv');
const scoreDisp = document.getElementById('score');
const msgContainer = document.getElementById('msg-container');
const msgDisp = document.getElementById('msg');
const actionBtn = document.getElementById('actionBtn');

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// --- ÂúñÁâáÁ¥†Êùê ---
const rawBase = `https://raw.githubusercontent.com/cposram/cow/main/`;
const imgAssets = {
    bg: new Image(),
    cowNormal: new Image(),
    cowGold: new Image(),
    lasso: new Image()
};
imgAssets.bg.src = rawBase + 'game_bg.png';
imgAssets.cowNormal.src = rawBase + 'cow_normal.png';
imgAssets.cowGold.src = rawBase + 'cow_gold.png';
imgAssets.lasso.src = rawBase + 'lasso_loop.png';

// --- ÈÅäÊà≤ËÆäÊï∏ ---
let level = 1;
let score = 0;
let gameState = 'RUNNING'; 
let pullProgress = 0;
let shakeAmount = 0;
let frameCount = 0;

let lasso = { x: 0, y: 0, active: false, speed: 25, radius: 45 };

class Cow {
    constructor(isGold = false) {
        this.isGold = isGold;
        this.width = isGold ? 150 : 120;
        this.height = isGold ? 120 : 90;
        this.x = -200;
        this.y = canvas.height * 0.75 - this.height;
        this.speed = (5 + level * 1.2);
        this.strugglePower = 0.3 + (level * 0.1);
    }
    update() {
        if (gameState === 'RUNNING') {
            this.x += this.speed;
        } else if (gameState === 'CATCHING') {
            let targetX = (canvas.width / 2) + (100 - pullProgress) * 2;
            this.x += (targetX - this.x) * 0.1; 
        }
    }
    draw() {
        const img = this.isGold ? imgAssets.cowGold : imgAssets.cowNormal;
        if (img.complete && img.naturalWidth !== 0) {
            ctx.drawImage(img, this.x, this.y, this.width, this.height);
        } else {
            ctx.fillStyle = this.isGold ? 'gold' : 'white';
            ctx.fillRect(this.x, this.y, this.width, this.height);
        }
    }
}

let currentCow = new Cow();

function initLevel(nextLevel) {
    level = nextLevel;
    lvDisp.innerText = level;
    currentCow = new Cow(level === 3 || level === 6);
    gameState = 'RUNNING';
    msgContainer.style.display = 'none';
    shakeAmount = 0;
    resetLasso();
}

function resetLasso() {
    lasso.active = false;
    lasso.y = canvas.height - 100;
    lasso.x = canvas.width / 2;
}

function drawCoverBackground(img) {
    if (!img.complete || img.naturalWidth === 0) {
        ctx.fillStyle = '#388E3C';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        return;
    }
    const imgRatio = img.naturalWidth / img.naturalHeight;
    const canvasRatio = canvas.width / canvas.height;
    let dWidth, dHeight, dx, dy;
    if (canvasRatio > imgRatio) {
        dWidth = canvas.width; dHeight = canvas.width / imgRatio;
        dx = 0; dy = (canvas.height - dHeight) / 2;
    } else {
        dWidth = canvas.height * imgRatio; dHeight = canvas.height;
        dx = (canvas.width - dWidth) / 2; dy = 0;
    }
    ctx.drawImage(img, dx, dy, dWidth, dHeight);
}

function gameLoop() {
    frameCount++;
    
    // Âè™ÊúâÂú®ÊçïÁç≤Ê®°ÂºèÊôÇÊâçË®àÁÆóÈúáÂãïÂÅèÁßª
    let offsetX = 0, offsetY = 0;
    if (gameState === 'CATCHING') {
        offsetX = (Math.random() - 0.5) * shakeAmount;
        offsetY = (Math.random() - 0.5) * shakeAmount;
        shakeAmount *= 0.95; // ÈúáÂãïËá™ÂãïË°∞Ê∏õ
    }
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(offsetX, offsetY);

    drawCoverBackground(imgAssets.bg);

    currentCow.update();
    currentCow.draw();

    if (currentCow.x > canvas.width + 100) {
        currentCow = new Cow(level === 3 || level === 6);
    }

    if (lasso.active && gameState === 'RUNNING') {
        lasso.y -= lasso.speed;
        if (imgAssets.lasso.complete) {
            ctx.drawImage(imgAssets.lasso, canvas.width/2 - lasso.radius, lasso.y - lasso.radius, lasso.radius*2, lasso.radius*2);
        }
        let cowCenterX = currentCow.x + currentCow.width/2;
        let cowCenterY = currentCow.y + currentCow.height/2;
        if (Math.abs(lasso.y - cowCenterY) < 45 && Math.abs(canvas.width/2 - cowCenterX) < 65) {
            gameState = 'CATCHING';
            pullProgress = 35;
            shakeAmount = 15;
        }
        if (lasso.y < -100) resetLasso();
    }

    if (gameState === 'CATCHING') {
        pullProgress -= currentCow.strugglePower;
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, canvas.height);
        ctx.quadraticCurveTo(
            canvas.width / 2 + Math.sin(frameCount * 0.3) * 15, canvas.height * 0.7, 
            currentCow.x + currentCow.width/2, currentCow.y + currentCow.height/2
        );
        ctx.strokeStyle = '#4e342e';
        ctx.lineWidth = 5;
        ctx.stroke();

        drawProgressBar();

        if (pullProgress <= 0) failCatch();
        else if (pullProgress >= 100) successCatch();
    }

    ctx.restore();
    requestAnimationFrame(gameLoop);
}

function drawProgressBar() {
    const barW = canvas.width * 0.6, barH = 15;
    const x = canvas.width / 2 - barW / 2, y = 100;
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(x - 2, y - 2, barW + 4, barH + 4);
    ctx.fillStyle = '#f00';
    ctx.fillRect(x, y, barW, barH);
    ctx.fillStyle = '#0f0';
    ctx.fillRect(x, y, (pullProgress/100) * barW, barH);
}

function successCatch() {
    gameState = 'SUCCESS';
    score += level * 100;
    scoreDisp.innerText = score;
    
    if (level < 6) {
        showMsg("ÊàêÂäüÊçïÁç≤ÔºÅ", ""); // Ê≤íÊåâÈàïÔºåËá™ÂãïÈÄ≤‰∏ã‰∏ÄÈóú
        setTimeout(() => initLevel(level + 1), 1500);
    } else {
        showMsg("üéâ ÈÄöÈóúÂÖ® 6 ÈóúÔºÅ", "ÂÜçÁé©‰∏ÄÊ¨°");
    }
}

function failCatch() {
    gameState = 'FAIL';
    showMsg("ÂìéÂëÄÔºÅË¢´ÈÄÉË∑ë‰∫Ü...", "ÂÜçÊåëÊà∞‰∏ÄÊ¨°");
}

function showMsg(text, btnText) {
    msgDisp.innerHTML = text;
    if (btnText) {
        actionBtn.innerText = btnText;
        actionBtn.style.display = 'inline-block';
    } else {
        actionBtn.style.display = 'none';
    }
    msgContainer.style.display = 'block';
}

function handleBtnClick() {
    if (gameState === 'FAIL') {
        initLevel(level); // ÈáçÁé©Êú¨Èóú
    } else if (level === 6) {
        score = 0;
        scoreDisp.innerText = 0;
        initLevel(1); // ÂõûÂà∞Á¨¨‰∏ÄÈóú
    }
}

function handleInput(e) {
    if (e) e.preventDefault();
    if (gameState === 'RUNNING' && !lasso.active) {
        lasso.active = true;
    } else if (gameState === 'CATCHING') {
        pullProgress += 10;
        shakeAmount = 15; // ÊãâÊâØÊôÇÊâçÊÅ¢Âæ©ÈúáÂãïÊÑü
    }
}

canvas.addEventListener('touchstart', handleInput, {passive: false});
window.addEventListener('mousedown', (e) => { if(e.button === 0) handleInput(e); });

initLevel(1);
gameLoop();
</script>
</body>
</html>
