<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¤¾å€æŠ“ç‰›å¤§è³½ - å²¡è¯ç‰§å ´ç‰¹åˆ¥ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: "Microsoft JhengHei", sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: env(safe-area-inset-top, 20px); left: 20px; color: white; text-shadow: 2px 2px 4px #000; font-size: 22px; pointer-events: none; z-index: 10; }
        /* å°‡è¨Šæ¯æ¡†ä½ç½®ä¸Šç§»ï¼Œé¿å…æ“‹ä½ä¸»è§’ */
        #msg-container { 
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; display: none; width: 95%; z-index: 20; 
        }
        #msg { color: #FFD700; font-size: 38px; font-weight: bold; text-shadow: 3px 3px 0 #000; margin-bottom: 25px; line-height: 1.4; }
        .game-btn { 
            background: linear-gradient(#FFB74D, #FF9800); color: white; border: none; padding: 15px 35px; 
            font-size: 22px; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 6px 0 #E65100; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .game-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #E65100; }
    </style>
</head>
<body>

<div id="ui">
    ğŸ† é—œå¡: <span id="lv">1</span> / 6 <br>
    ğŸ’° åˆ†æ•¸: <span id="score">0</span>
</div>

<div id="msg-container">
    <div id="msg"></div>
    <button id="actionBtn" class="game-btn" onclick="handleBtnClick()"></button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lvDisp = document.getElementById('lv');
const scoreDisp = document.getElementById('score');
const msgContainer = document.getElementById('msg-container');
const msgDisp = document.getElementById('msg');
const actionBtn = document.getElementById('actionBtn');

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

const rawBase = `https://raw.githubusercontent.com/cposram/cow/main/`;
const imgAssets = {
    bg: new Image(), lasso: new Image(), cowNormal: new Image(), 
    cowGold: new Image(), cowDiamond: new Image(), cowGalaxy: new Image(), 
    cowLegendary: new Image(), hero: new Image()
};

// ä½¿ç”¨æ–°çš„å¸¶æœ‰æ–‡å­—èªªæ˜çš„èƒŒæ™¯åœ–
imgAssets.bg.src = rawBase + 'game_bg_ganglian_text.png';
imgAssets.lasso.src = rawBase + 'lasso_loop.png';
imgAssets.cowNormal.src = rawBase + 'cow_normal.png';
imgAssets.cowGold.src = rawBase + 'cow_gold.png';
imgAssets.cowDiamond.src = rawBase + 'cow_diamond.png';
imgAssets.cowGalaxy.src = rawBase + 'cow_galaxy.png';
imgAssets.cowLegendary.src = rawBase + 'cow_legendary.png';
imgAssets.hero.src = rawBase + 'cowboy_hero.png';

let level = 1;
let score = 0;
let gameState = 'RUNNING'; 
let pullProgress = 0;
let shakeAmount = 0;
let frameCount = 0;

let lasso = { x: 0, y: 0, active: false, speed: 30, radius: 50 };

class Cow {
    constructor(lv) {
        this.lv = lv;
        if (lv <= 2) this.img = imgAssets.cowNormal;
        else if (lv === 3) this.img = imgAssets.cowGold;
        else if (lv === 4) this.img = imgAssets.cowDiamond;
        else if (lv === 5) this.img = imgAssets.cowGalaxy;
        else this.img = imgAssets.cowLegendary;

        this.width = 140 + (lv * 20); 
        this.height = this.width * 0.75;
        this.x = -250;
        // å¾®èª¿ç‰›çš„ä½ç½®ï¼Œè®“ç‰ ç«™åœ¨å‰æ™¯è‰åœ°ä¸Š
        this.y = canvas.height * 0.85 - this.height;
        this.speed = (6 + lv * 1.5);
        this.strugglePower = 0.35 + (lv * 0.15); 
    }
    update() {
        if (gameState === 'RUNNING') {
            this.x += this.speed;
        } else if (gameState === 'CATCHING') {
            let targetX = (canvas.width / 2) + (100 - pullProgress) * 2;
            this.x += (targetX - this.x) * 0.1; 
        }
    }
    draw() {
        if (this.img.complete && this.img.naturalWidth !== 0) {
            ctx.drawImage(this.img, this.x, this.y, this.width, this.height);
        }
    }
}

let currentCow = new Cow(1);

function initLevel(nextLevel) {
    level = nextLevel;
    lvDisp.innerText = level;
    currentCow = new Cow(level);
    gameState = 'RUNNING';
    msgContainer.style.display = 'none';
    shakeAmount = 0;
    resetLasso();
}

function resetLasso() {
    lasso.active = false;
    // å¾®èª¿å¥—ç´¢åˆå§‹ä½ç½®
    lasso.y = canvas.height - 100;
    lasso.x = canvas.width / 2;
}

// ã€æ ¸å¿ƒä¿®æ­£ã€‘å…¨æ–°çš„èƒŒæ™¯ç¹ªè£½å‡½å¼ï¼Œç¢ºä¿ä¸è£åˆ‡
function drawFixedBackground(img) {
    if (!img.complete || img.naturalWidth === 0) {
        ctx.fillStyle = '#87CEEB'; // å¤©ç©ºè—å‚™ç”¨åº•è‰²
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        return;
    }

    // 1. è¨ˆç®—æ¯”ä¾‹ï¼Œè®“åœ–ç‰‡å¯¬åº¦å‰›å¥½å¡«æ»¿è¢å¹•å¯¬åº¦
    const scale = canvas.width / img.naturalWidth;
    const scaledHeight = img.naturalHeight * scale;

    // 2. å¾é ‚éƒ¨é–‹å§‹ç¹ªè£½ï¼Œç¢ºä¿ä¸Šæ–¹æ–‡å­—å’Œå®Œæ•´å¯¬åº¦éƒ½èƒ½é¡¯ç¤º
    ctx.drawImage(img, 0, 0, canvas.width, scaledHeight);

    // 3. å¦‚æœè¢å¹•æ¯”è¼ƒé•·ï¼Œä¸‹æ–¹æœ‰ç©ºç™½ï¼Œå°±ç”¨åœ–ç‰‡åº•éƒ¨çš„è‰åœ°ç´‹ç†ä¾†å¡«æ»¿
    if (scaledHeight < canvas.height) {
        // å–åœ–ç‰‡æœ€åº•éƒ¨ 10px é«˜çš„è‰åœ°
        const sourceY = img.naturalHeight - 10;
        const sourceH = 10;
        // å¡«æ»¿å‰©é¤˜çš„ç©ºé–“
        const drawY = scaledHeight;
        const drawH = canvas.height - scaledHeight;
        
        // å°‡é‚£ä¸€å°æ¢è‰åœ°æ‹‰ä¼¸å¡«æ»¿ä¸‹æ–¹
        ctx.drawImage(
            img, 
            0, sourceY, img.naturalWidth, sourceH, // ä¾†æºå€åŸŸ
            0, drawY, canvas.width, drawH          // ç›®æ¨™å€åŸŸ
        );
    }
}

function gameLoop() {
    frameCount++;
    let offsetX = 0, offsetY = 0;

    if (gameState === 'CATCHING') {
        offsetX = (Math.random() - 0.5) * shakeAmount;
        offsetY = (Math.random() - 0.5) * shakeAmount;
        shakeAmount *= 0.96;
    }
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (gameState === 'VICTORY') {
        drawVictoryScene();
    } else {
        ctx.save();
        ctx.translate(offsetX, offsetY);
        // ä½¿ç”¨æ–°çš„èƒŒæ™¯ç¹ªè£½å‡½å¼
        drawFixedBackground(imgAssets.bg);

        // ç¹ªè£½ä¸»è§’ï¼Œä½ç½®å¾®èª¿ä¸‹ç§»
        const hW = 120, hH = 150;
        if (imgAssets.hero.complete) {
            ctx.drawImage(imgAssets.hero, canvas.width/2 - hW/2, canvas.height - 150, hW, hH);
        }

        currentCow.update();
        currentCow.draw();

        if (currentCow.x > canvas.width + 200) {
            currentCow = new Cow(level);
        }

        if (lasso.active && gameState === 'RUNNING') {
            lasso.y -= lasso.speed;
            if (imgAssets.lasso.complete) {
                ctx.drawImage(imgAssets.lasso, canvas.width/2 - lasso.radius, lasso.y - lasso.radius, lasso.radius*2, lasso.radius*2);
            }
            let cowCenterX = currentCow.x + currentCow.width/2;
            let cowCenterY = currentCow.y + currentCow.height/2;
            // èª¿æ•´ç¢°æ’åµæ¸¬ç¯„åœ
            if (Math.abs(lasso.y - cowCenterY) < 70 && Math.abs(canvas.width/2 - cowCenterX) < 80) {
                gameState = 'CATCHING';
                pullProgress = 40; 
                shakeAmount = 20;
            }
            if (lasso.y < -100) resetLasso();
        }

        if (gameState === 'CATCHING') {
            pullProgress -= currentCow.strugglePower;
            ctx.beginPath();
            // å¥—ç´¢èµ·é»å¾®èª¿
            ctx.moveTo(canvas.width / 2, canvas.height - 80);
            ctx.quadraticCurveTo(
                canvas.width / 2 + Math.sin(frameCount * 0.3) * 20, canvas.height * 0.6, 
                currentCow.x + currentCow.width/2, currentCow.y + currentCow.height/2
            );
            ctx.strokeStyle = '#4e342e';
            ctx.lineWidth = 6;
            ctx.stroke();
            drawProgressBar();
            if (pullProgress <= 0) failCatch();
            else if (pullProgress >= 100) successCatch();
        }
        ctx.restore();
    }
    requestAnimationFrame(gameLoop);
}

function drawProgressBar() {
    const barW = canvas.width * 0.7, barH = 20;
    // é€²åº¦æ¢ä½ç½®ä¸Šç§»ï¼Œé¿é–‹ä¸»è§’
    const x = canvas.width / 2 - barW / 2, y = 60;
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(x - 4, y - 4, barW + 8, barH + 8);
    ctx.fillStyle = '#666';
    ctx.fillRect(x, y, barW, barH);
    ctx.fillStyle = (pullProgress > 30) ? '#0f0' : '#f00';
    ctx.fillRect(x, y, (pullProgress/100) * barW, barH);
}

function drawVictoryScene() {
    // å‹åˆ©ç•«é¢ä¹Ÿä½¿ç”¨æ–°çš„èƒŒæ™¯ç¹ªè£½å‡½å¼
    drawFixedBackground(imgAssets.bg);
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;

    for(let i=0; i<20; i++) {
        ctx.fillStyle = i % 2 === 0 ? 'gold' : 'white';
        ctx.beginPath();
        ctx.arc((frameCount*6 + i*80) % canvas.width, (frameCount*3 + i*60) % canvas.height, 6, 0, Math.PI*2);
        ctx.fill();
    }

    const hW = 150, hH = 190;
    if (imgAssets.hero.complete) {
        ctx.drawImage(imgAssets.hero, centerX - hW/2, centerY - 80, hW, hH);
    }

    const cows = [imgAssets.cowNormal, imgAssets.cowGold, imgAssets.cowDiamond, imgAssets.cowGalaxy, imgAssets.cowLegendary];
    cows.forEach((img, i) => {
        const cw = 100 + (i * 15), ch = cw * 0.75;
        if (img.complete) {
            ctx.drawImage(img, centerX - (i*50) - 180, centerY + 80 + Math.sin(frameCount*0.1 + i)*15, cw, ch);
            ctx.drawImage(img, centerX + (i*50) + 80, centerY + 80 + Math.sin(frameCount*0.1 + i)*15, cw, ch);
        }
    });
}

function successCatch() {
    gameState = 'SUCCESS';
    score += level * 150;
    scoreDisp.innerText = score;
    if (level < 6) {
        showMsg("æˆåŠŸæ•ç²ï¼", ""); 
        setTimeout(() => initLevel(level + 1), 1200);
    } else {
        gameState = 'VICTORY';
        showMsg("ğŸ‰ å‚³èªªé”æˆï¼<br>ä½ æ˜¯æœ€å¼·ç‰›ä»”ï¼", "å†ç©ä¸€æ¬¡");
    }
}

function failCatch() {
    gameState = 'FAIL';
    showMsg("å“å‘€ï¼è¢«é€ƒè·‘äº†...", "å†æŒ‘æˆ°ä¸€æ¬¡");
}

function showMsg(text, btnText) {
    msgDisp.innerHTML = text;
    if (btnText) {
        actionBtn.innerText = btnText;
        actionBtn.style.display = 'inline-block';
    } else {
        actionBtn.style.display = 'none';
    }
    msgContainer.style.display = 'block';
}

function handleBtnClick() {
    if (gameState === 'FAIL') initLevel(level);
    else if (gameState === 'VICTORY') {
        score = 0; scoreDisp.innerText = 0; initLevel(1);
    }
}

function handleInput(e) {
    if (e) e.preventDefault();
    if (gameState === 'RUNNING' && !lasso.active) {
        lasso.active = true;
    } else if (gameState === 'CATCHING') {
        pullProgress += 12; 
        shakeAmount = 18;
    }
}

canvas.addEventListener('touchstart', handleInput, {passive: false});
window.addEventListener('mousedown', (e) => { if(e.button === 0) handleInput(e); });

initLevel(1);
gameLoop();
</script>
</body>
</html>
