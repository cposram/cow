<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¤¾å€æŠ“ç‰›å¤§è³½ - å²¡è¯ç‰§å ´ç‰¹åˆ¥ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: "Microsoft JhengHei", sans-serif; touch-action: none; }
        canvas { display: block; }
        
        /* ç‰§å ´ä»‹ç´¹ï¼šç›´æ¥ç”¨ä»£ç¢¼é¡¯ç¤ºï¼Œä¿è­‰ä¸è¢«è£åˆ‡ */
        #ranch-story {
            position: absolute; top: 15px; left: 15px; width: 65%;
            color: white; font-size: 14px; line-height: 1.5;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8); pointer-events: none; z-index: 5;
        }

        #ui { position: absolute; top: 15px; right: 15px; color: white; text-shadow: 2px 2px 4px #000; font-size: 20px; pointer-events: none; z-index: 10; text-align: right; }
        
        #msg-container { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; display: none; width: 90%; z-index: 20; 
        }
        #msg { color: #FFD700; font-size: 34px; font-weight: bold; text-shadow: 3px 3px 0 #000; margin-bottom: 20px; }
        .game-btn { 
            background: linear-gradient(#FFB74D, #FF9800); color: white; border: none; padding: 12px 30px; 
            font-size: 20px; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #E65100; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="ranch-story">
    <b>å²¡è¯ç‰§å ´</b><br>
    å‰µç«‹æ–¼æ°‘åœ‹59å¹´ï¼Œç¶“ç‡Ÿ55å¹´é£¼é¤Šç´„300éš»ä¹³ç‰›ã€‚<br>
    æ°‘åœ‹94å¹´æˆç«‹é®®ä¹³é–€å¸‚ï¼Œè®“éŠå®¢é«”é©—çœŸå¯¦çš„é…ªè¾²ç”Ÿæ´»ã€‚
</div>

<div id="ui">
    ğŸ† é—œå¡: <span id="lv">1</span> / 6 <br>
    ğŸ’° åˆ†æ•¸: <span id="score">0</span>
</div>

<div id="msg-container">
    <div id="msg"></div>
    <button id="actionBtn" class="game-btn" onclick="handleBtnClick()"></button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lvDisp = document.getElementById('lv'), scoreDisp = document.getElementById('score');
const msgContainer = document.getElementById('msg-container'), msgDisp = document.getElementById('msg');
const actionBtn = document.getElementById('actionBtn');

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

// è«‹ç¢ºèª GitHub ä¸Šçš„åœ–æª”è·¯å¾‘
const rawBase = `https://raw.githubusercontent.com/cposram/cow/main/`;
const imgAssets = {
    bg: new Image(), lasso: new Image(), cowNormal: new Image(), 
    cowGold: new Image(), cowDiamond: new Image(), cowGalaxy: new Image(), 
    cowLegendary: new Image(), hero: new Image()
};

// è¼‰å…¥è³‡æº
imgAssets.bg.src = rawBase + 'game_bg_pure.png'; 
imgAssets.lasso.src = rawBase + 'lasso_loop.png';
imgAssets.cowNormal.src = rawBase + 'cow_normal.png';
imgAssets.cowGold.src = rawBase + 'cow_gold.png';
imgAssets.cowDiamond.src = rawBase + 'cow_diamond.png';
imgAssets.cowGalaxy.src = rawBase + 'cow_galaxy.png';
imgAssets.cowLegendary.src = rawBase + 'cow_legendary.png';
imgAssets.hero.src = rawBase + 'cowboy_hero.png';

let level = 1, score = 0, gameState = 'RUNNING', pullProgress = 0;
let lasso = { y: 0, active: false, speed: 32 };

class Cow {
    constructor(lv) {
        this.lv = lv;
        const imgs = [imgAssets.cowNormal, imgAssets.cowNormal, imgAssets.cowGold, imgAssets.cowDiamond, imgAssets.cowGalaxy, imgAssets.cowLegendary];
        this.img = imgs[lv-1] || imgs[0];
        this.width = 140 + (lv * 20); this.height = this.width * 0.75;
        this.x = -250; 
        this.y = canvas.height * 0.82 - this.height;
        this.speed = (5 + lv * 1.3);
        this.strugglePower = 0.3 + (lv * 0.08); // é›£åº¦èª¿å„ªï¼Œç¢ºä¿å¾ŒæœŸèƒ½éé—œ
    }
    update() {
        if (gameState === 'RUNNING') this.x += this.speed;
        else if (gameState === 'CATCHING') {
            this.x += ((canvas.width/2 + (100 - pullProgress)*1.5) - this.x) * 0.1;
        }
    }
    draw() { if (this.img.complete) ctx.drawImage(this.img, this.x, this.y, this.width, this.height); }
}

let currentCow = new Cow(1);

function initLevel(nextLevel) {
    level = nextLevel; lvDisp.innerText = level;
    currentCow = new Cow(level); gameState = 'RUNNING';
    msgContainer.style.display = 'none'; resetLasso();
}

function resetLasso() { lasso.active = false; lasso.y = canvas.height - 120; }

function drawBG() {
    if (imgAssets.bg.complete && imgAssets.bg.naturalWidth !== 0) {
        const s = Math.max(canvas.width / imgAssets.bg.naturalWidth, canvas.height / imgAssets.bg.naturalHeight);
        const w = imgAssets.bg.naturalWidth * s, h = imgAssets.bg.naturalHeight * s;
        ctx.drawImage(imgAssets.bg, (canvas.width - w) / 2, (canvas.height - h) / 2, w, h);
    } else {
        // é˜²è—å±å‚™æ¡ˆï¼šæ¼¸å±¤å¤©ç©º
        let grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grd.addColorStop(0, "#87CEEB");
        grd.addColorStop(1, "#4CAF50");
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBG();
    
    if (imgAssets.hero.complete) ctx.drawImage(imgAssets.hero, canvas.width/2 - 60, canvas.height - 180, 120, 150);
    
    currentCow.update(); currentCow.draw();
    if (currentCow.x > canvas.width + 300) currentCow = new Cow(level);

    if (lasso.active && gameState === 'RUNNING') {
        lasso.y -= lasso.speed;
        if (imgAssets.lasso.complete) ctx.drawImage(imgAssets.lasso, canvas.width/2-45, lasso.y-45, 90, 90);
        if (Math.abs(lasso.y - (currentCow.y + currentCow.height/2)) < 60 && Math.abs(canvas.width/2 - (currentCow.x + currentCow.width/2)) < 70) {
            gameState = 'CATCHING'; pullProgress = 50;
        }
        if (lasso.y < -50) resetLasso();
    }

    if (gameState === 'CATCHING') {
        pullProgress -= currentCow.strugglePower;
        ctx.beginPath(); ctx.moveTo(canvas.width/2, canvas.height-120);
        ctx.lineTo(currentCow.x + currentCow.width/2, currentCow.y + currentCow.height/2);
        ctx.strokeStyle = '#4e342e'; ctx.lineWidth = 6; ctx.stroke();
        drawBar();
        if (pullProgress <= 0) failCatch();
        else if (pullProgress >= 100) successCatch();
    }
    requestAnimationFrame(gameLoop);
}

function drawBar() {
    const w = canvas.width * 0.7;
    ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(canvas.width/2 - w/2, 100, w, 20);
    ctx.fillStyle = pullProgress > 30 ? '#0f0' : '#f00';
    ctx.fillRect(canvas.width/2 - w/2, 100, (pullProgress/100)*w, 20);
}

function successCatch() {
    gameState = 'SUCCESS'; score += level * 100; scoreDisp.innerText = score;
    if (level < 6) { showMsg("æŠ“åˆ°äº†ï¼", ""); setTimeout(() => initLevel(level+1), 1000); }
    else { showMsg("ğŸ‰ å‚³èªªé”æˆï¼", "å†ç©ä¸€æ¬¡"); }
}

function failCatch() { gameState = 'FAIL'; showMsg("é€ƒè·‘äº†...", "é‡è©¦"); }

function showMsg(t, b) { 
    msgDisp.innerHTML = t; 
    actionBtn.innerText = b; 
    actionBtn.style.display = b ? "inline-block" : "none"; 
    msgContainer.style.display = "block"; 
}

function handleBtnClick() { if (gameState === 'FAIL' || level === 6) { score = 0; initLevel(1); } }

function handleInput(e) {
    if (e) e.preventDefault();
    if (gameState === 'RUNNING' && !lasso.active) lasso.active = true;
    else if (gameState === 'CATCHING') pullProgress += 15;
}

canvas.addEventListener('touchstart', handleInput, {passive: false});
window.addEventListener('mousedown', (e) => { if(e.button===0) handleInput(e); });
initLevel(1); gameLoop();
</script>
</body>
</html>
