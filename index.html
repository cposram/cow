<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¤¾å€æŠ“ç‰›å¤§è³½ - ç‰©ç†å‹•æ…‹ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background: #4CAF50; font-family: "Microsoft JhengHei", sans-serif; touch-action: none; }
        canvas { display: block; background: linear-gradient(#87CEEB, #E0F7FA 70%, #4CAF50 70%); }
        #ui { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 2px 2px 4px #000; font-size: 24px; pointer-events: none; }
        #msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #FFD700; font-size: 40px; font-weight: bold; text-align: center; display: none; text-shadow: 3px 3px 0 #000; width: 80%; }
        #hint { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px; font-size: 18px; }
    </style>
</head>
<body>

<div id="ui">
    ğŸ† é—œå¡: <span id="lv">1</span> / 6 <br>
    ğŸ’° åˆ†æ•¸: <span id="score">0</span>
</div>
<div id="msg"></div>
<div id="hint">é»æ“Šè¢å¹•æ‹‹å‡ºç¹©ç´¢ï¼å¥—ä¸­å¾Œç˜‹ç‹‚é€£é»ï¼</div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lvDisp = document.getElementById('lv');
const scoreDisp = document.getElementById('score');
const msgDisp = document.getElementById('msg');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
let level = 1;
let score = 0;
let gameState = 'RUNNING'; // RUNNING, CATCHING, SUCCESS, ANIMATION
let pullProgress = 0;
let shakeAmount = 0;
let frameCount = 0;

// --- ç¹©ç´¢ç‰©ä»¶ ---
let lasso = {
    x: canvas.width / 2,
    y: canvas.height - 100,
    active: false,
    speed: 20,
    radius: 40
};

// --- ç‰›ç‰©ä»¶é¡åˆ¥ ---
class Cow {
    constructor(isGold = false) {
        this.isGold = isGold;
        this.width = isGold ? 150 : 120;
        this.height = isGold ? 120 : 100;
        this.x = -200;
        this.y = canvas.height * 0.75 - this.height; // è·‘åœ¨è‰åœ°ä¸Š
        this.speed = (4 + level * 1.5);
        this.strugglePower = 0.2 + (level * 0.15); // æ¯å¹€æµå¤±çš„æ‹‰åŠ›
    }
    update() {
        if (gameState === 'RUNNING') {
            this.x += this.speed;
        } else if (gameState === 'CATCHING') {
            // ç‰©ç†ï¼šç‰›çš„ä½ç½®éš¨æ‹‰åŠ›é€²åº¦å‰å¾Œç§»å‹•
            let targetX = (canvas.width / 2) + (100 - pullProgress) * 3;
            this.x += (targetX - this.x) * 0.1; 
        }
    }
    draw() {
        ctx.save();
        // ç°¡å–®ç¹ªè£½ placeholderï¼Œç›´åˆ°ä½ æ›æˆ GitHub ä¸Šçš„ AI ç´ æ
        ctx.fillStyle = this.isGold ? '#FFD700' : '#FFF';
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        // èº«é«”
        ctx.fillRect(this.x, this.y, this.width, this.height);
        ctx.strokeRect(this.x, this.y, this.width, this.height);
        // é ­éƒ¨ (ç°¡å–®ç¤ºæ„)
        ctx.fillStyle = '#FFC0CB';
        ctx.fillRect(this.x + this.width - 20, this.y + 10, 30, 40);
        ctx.restore();
    }
}

let currentCow = new Cow();

// --- æ ¸å¿ƒé‚è¼¯ ---
function initLevel(nextLevel) {
    level = nextLevel;
    lvDisp.innerText = level;
    currentCow = new Cow(level === 3);
    gameState = 'RUNNING';
    msgDisp.style.display = 'none';
    resetLasso();
}

function resetLasso() {
    lasso.active = false;
    lasso.y = canvas.height - 100;
}

function gameLoop() {
    frameCount++;
    // éœ‡å‹•ç‰©ç†è¨ˆç®—
    let offsetX = (Math.random() - 0.5) * shakeAmount;
    let offsetY = (Math.random() - 0.5) * shakeAmount;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(offsetX, offsetY);

    // 1. ç¹ªè£½ç’°å¢ƒï¼ˆè‰åœ°èˆ‡è·¯å¾‘ï¼‰
    ctx.fillStyle = '#388E3C';
    ctx.fillRect(0, canvas.height * 0.7, canvas.width, canvas.height * 0.3);

    // 2. æ›´æ–°èˆ‡ç¹ªè£½ç‰›
    currentCow.update();
    currentCow.draw();
    if (currentCow.x > canvas.width) {
        currentCow = new Cow(level === 3); // è·‘æ‰å°±é‡æ–°å‡ºä¸€éš»
    }

    // 3. ç¹ªè£½ç¹©ç´¢
    if (lasso.active) {
        if (gameState === 'RUNNING') {
            lasso.y -= lasso.speed;
            // ç¹ªè£½é£›è¡Œä¸­çš„å¥—ç´¢
            ctx.beginPath();
            ctx.arc(canvas.width / 2, lasso.y, lasso.radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#6d4c41';
            ctx.lineWidth = 5;
            ctx.stroke();
            
            // ç¢°æ’åˆ¤å®š
            if (Math.abs(lasso.y - (currentCow.y + 50)) < 40 && 
                Math.abs(canvas.width / 2 - (currentCow.x + currentCow.width/2)) < 60) {
                gameState = 'CATCHING';
                pullProgress = 30;
                shakeAmount = 15;
            }
            if (lasso.y < 50) resetLasso();
        }
    }

    // 4. æŠ“æ•æ¨¡å¼ (æ‹”æ²³ç‰©ç†)
    if (gameState === 'CATCHING') {
        pullProgress -= currentCow.strugglePower;
        
        // ç¹ªè£½é€£åˆ°çš„ç¹©ç´¢ï¼ˆå—å¼µåŠ›å½±éŸ¿çš„æ›²ç·šï¼‰
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, canvas.height);
        ctx.quadraticCurveTo(
            canvas.width / 2 + Math.sin(frameCount * 0.2) * 20, 
            canvas.height * 0.8, 
            currentCow.x + 20, currentCow.y + 50
        );
        ctx.strokeStyle = '#4e342e';
        ctx.lineWidth = 6;
        ctx.stroke();

        // ç¹ªè£½æ‹‰åŠ›æ¢
        drawProgressBar();

        if (pullProgress <= 0) {
            failCatch();
        } else if (pullProgress >= 100) {
            successCatch();
        }
        shakeAmount *= 0.9;
    }

    ctx.restore();
    requestAnimationFrame(gameLoop);
}

function drawProgressBar() {
    const barW = 200;
    const barH = 20;
    const x = canvas.width / 2 - barW / 2;
    const y = 150;
    
    ctx.fillStyle = '#000';
    ctx.fillRect(x - 2, y - 2, barW + 4, barH + 4);
    ctx.fillStyle = '#f00';
    ctx.fillRect(x, y, barW, barH);
    ctx.fillStyle = '#0f0';
    ctx.fillRect(x, y, pullProgress * 2, barH);
    
    ctx.fillStyle = '#fff';
    ctx.font = '20px Arial';
    ctx.fillText('POWER!!', x + 60, y - 10);
}

function successCatch() {
    gameState = 'SUCCESS';
    score += level * 100;
    scoreDisp.innerText = score;
    
    if (level === 3) {
        showMsg("âœ¨ æ­å–œç²å¾—é»ƒé‡‘ç‰›ï¼ âœ¨<br>å®¶æ—çå‹µé ’ç™¼ä¸­...");
    } else {
        showMsg("æˆåŠŸæ•ç²ï¼");
    }

    setTimeout(() => {
        if (level < 6) {
            initLevel(level + 1);
        } else {
            showMsg("ğŸ‰ æ­å–œé€šé—œå…¨ 6 é—œï¼<br>ä½ æ˜¯ç¤¾å€æœ€å¼·ç‰›ä»”ï¼");
        }
    }, 2500);
}

function failCatch() {
    gameState = 'ANIMATION';
    showMsg("å“å‘€ï¼è¢«é€ƒè·‘äº†ï¼");
    setTimeout(() => {
        initLevel(level); // é‡ç©æœ¬é—œ
    }, 1500);
}

function showMsg(text) {
    msgDisp.innerHTML = text;
    msgDisp.style.display = 'block';
}

// --- è¼¸å…¥æ§åˆ¶ ---
function handleInput() {
    if (gameState === 'RUNNING' && !lasso.active) {
        lasso.active = true;
    } else if (gameState === 'CATCHING') {
        pullProgress += 7; // æ¯æ¬¡é»æ“Šå¢åŠ æ‹‰åŠ›
        shakeAmount = 8;   // å¢åŠ éœ‡å‹•æ„Ÿ
    }
}

window.addEventListener('mousedown', (e) => { e.preventDefault(); handleInput(); });
window.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(); });

// å•Ÿå‹•éŠæˆ²
initLevel(1);
gameLoop();

</script>
</body>
</html>

