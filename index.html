<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¤¾å€æŠ“ç‰›å¤§è³½ - è¦–è¦ºå‡ç´šç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background: #4CAF50; font-family: "Microsoft JhengHei", sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 2px 2px 4px #000; font-size: 24px; pointer-events: none; z-index: 10; }
        #msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #FFD700; font-size: 40px; font-weight: bold; text-align: center; display: none; text-shadow: 3px 3px 0 #000; width: 80%; z-index: 10; }
        #hint { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px; font-size: 18px; z-index: 10; }
    </style>
</head>
<body>

<div id="ui">
    ğŸ† é—œå¡: <span id="lv">1</span> / 6 <br>
    ğŸ’° åˆ†æ•¸: <span id="score">0</span>
</div>
<div id="msg"></div>
<div id="hint">é»æ“Šè¢å¹•æ‹‹å‡ºç¹©ç´¢ï¼å¥—ä¸­å¾Œç˜‹ç‹‚é€£é»ï¼</div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lvDisp = document.getElementById('lv');
const scoreDisp = document.getElementById('score');
const msgDisp = document.getElementById('msg');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- åœ–ç‰‡ç´ æè¼‰å…¥ ---
const imgAssets = {
    bg: new Image(),
    cowNormal: new Image(),
    cowGold: new Image(),
    lasso: new Image()
};

imgAssets.bg.src = 'game_bg.png';
imgAssets.cowNormal.src = 'cow_normal.png';
imgAssets.cowGold.src = 'cow_gold.png';
imgAssets.lasso.src = 'lasso_loop.png';

// --- éŠæˆ²ç‹€æ…‹ ---
let level = 1;
let score = 0;
let gameState = 'RUNNING';
let pullProgress = 0;
let shakeAmount = 0;
let frameCount = 0;

let lasso = {
    x: canvas.width / 2,
    y: canvas.height - 100,
    active: false,
    speed: 20,
    radius: 50
};

class Cow {
    constructor(isGold = false) {
        this.isGold = isGold;
        this.width = isGold ? 160 : 130;
        this.height = isGold ? 130 : 100;
        this.x = -200;
        this.y = canvas.height * 0.78 - this.height;
        this.speed = (4 + level * 1.5);
        this.strugglePower = 0.25 + (level * 0.15);
    }
    update() {
        if (gameState === 'RUNNING') {
            this.x += this.speed;
        } else if (gameState === 'CATCHING') {
            let targetX = (canvas.width / 2) + (100 - pullProgress) * 3;
            this.x += (targetX - this.x) * 0.1; 
        }
    }
    draw() {
        const img = this.isGold ? imgAssets.cowGold : imgAssets.cowNormal;
        if (img.complete) {
            ctx.drawImage(img, this.x, this.y, this.width, this.height);
        } else {
            // å‚™ç”¨æ–¹æ¡ˆï¼šåœ–é‚„æ²’è·‘å‡ºä¾†æ™‚ç•«æ–¹å¡Š
            ctx.fillStyle = this.isGold ? 'gold' : 'white';
            ctx.fillRect(this.x, this.y, this.width, this.height);
        }
    }
}

let currentCow = new Cow();

function initLevel(nextLevel) {
    level = nextLevel;
    lvDisp.innerText = level;
    currentCow = new Cow(level === 3 || level === 6);
    gameState = 'RUNNING';
    msgDisp.style.display = 'none';
    resetLasso();
}

function resetLasso() {
    lasso.active = false;
    lasso.y = canvas.height - 100;
}

function gameLoop() {
    frameCount++;
    let offsetX = (Math.random() - 0.5) * shakeAmount;
    let offsetY = (Math.random() - 0.5) * shakeAmount;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(offsetX, offsetY);

    // 1. ç¹ªè£½èƒŒæ™¯åœ–
    if (imgAssets.bg.complete) {
        ctx.drawImage(imgAssets.bg, 0, 0, canvas.width, canvas.height);
    } else {
        ctx.fillStyle = '#388E3C';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // 2. ç‰›
    currentCow.update();
    currentCow.draw();
    if (currentCow.x > canvas.width) {
        currentCow = new Cow(level === 3 || level === 6);
    }

    // 3. ç¹ªè£½ç¹©ç´¢åœ–ç‰‡
    if (lasso.active && gameState === 'RUNNING') {
        lasso.y -= lasso.speed;
        if (imgAssets.lasso.complete) {
            ctx.drawImage(imgAssets.lasso, canvas.width / 2 - lasso.radius, lasso.y - lasso.radius, lasso.radius * 2, lasso.radius * 2);
        } else {
            ctx.beginPath();
            ctx.arc(canvas.width / 2, lasso.y, lasso.radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#6d4c41';
            ctx.lineWidth = 5;
            ctx.stroke();
        }

        if (Math.abs(lasso.y - (currentCow.y + currentCow.height/2)) < 50 && 
            Math.abs(canvas.width / 2 - (currentCow.x + currentCow.width/2)) < 70) {
            gameState = 'CATCHING';
            pullProgress = 30;
            shakeAmount = 15;
        }
        if (lasso.y < -50) resetLasso();
    }

    // 4. æ‹”æ²³
    if (gameState === 'CATCHING') {
        pullProgress -= currentCow.strugglePower;
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, canvas.height);
        ctx.quadraticCurveTo(
            canvas.width / 2 + Math.sin(frameCount * 0.2) * 20, 
            canvas.height * 0.8, 
            currentCow.x + currentCow.width/2, currentCow.y + currentCow.height/2
        );
        ctx.strokeStyle = '#4e342e';
        ctx.lineWidth = 6;
        ctx.stroke();

        drawProgressBar();

        if (pullProgress <= 0) failCatch();
        else if (pullProgress >= 100) successCatch();
        shakeAmount *= 0.9;
    }

    ctx.restore();
    requestAnimationFrame(gameLoop);
}

function drawProgressBar() {
    const barW = 200, barH = 20;
    const x = canvas.width / 2 - barW / 2, y = 150;
    ctx.fillStyle = '#000';
    ctx.fillRect(x - 2, y - 2, barW + 4, barH + 4);
    ctx.fillStyle = '#f00';
    ctx.fillRect(x, y, barW, barH);
    ctx.fillStyle = '#0f0';
    ctx.fillRect(x, y, pullProgress * 2, barH);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 20px Arial';
    ctx.fillText('POWER!!', x + 60, y - 10);
}

function successCatch() {
    gameState = 'SUCCESS';
    score += level * 100;
    scoreDisp.innerText = score;
    showMsg(level === 3 || level === 6 ? "âœ¨ å‚³èªªç´šç‰›éš»æ•ç²ï¼ âœ¨" : "æˆåŠŸæ•ç²ï¼");
    setTimeout(() => {
        if (level < 6) initLevel(level + 1);
        else showMsg("ğŸ‰ æ­å–œé€šé—œå…¨ 6 é—œï¼");
    }, 2000);
}

function failCatch() {
    gameState = 'ANIMATION';
    showMsg("å“å‘€ï¼è¢«é€ƒè·‘äº†ï¼");
    setTimeout(() => initLevel(level), 1200);
}

function showMsg(text) {
    msgDisp.innerHTML = text;
    msgDisp.style.display = 'block';
}

function handleInput() {
    if (gameState === 'RUNNING' && !lasso.active) {
        lasso.active = true;
    } else if (gameState === 'CATCHING') {
        pullProgress += 8;
        shakeAmount = 10;
    }
}

window.addEventListener('mousedown', (e) => { e.preventDefault(); handleInput(); });
window.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(); });

initLevel(1);
gameLoop();
</script>
</body>
</html>
