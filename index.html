<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å²¡è¯ç‰§å ´æŠ“ç‰›å¤§è³½ - å…¨çƒå‰ä¸‰çˆ­éœ¸æˆ°</title>
    <style>
        /* åŸºç¤è¨­å®š */
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: "Microsoft JhengHei", sans-serif; touch-action: none; }
        canvas { display: block; }
        
        #ranch-story { position: absolute; top: 15px; left: 15px; width: 60%; color: white; font-size: 13px; line-height: 1.5; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); pointer-events: none; z-index: 5; }
        
        #ui { position: absolute; top: 15px; right: 15px; color: white; text-shadow: 2px 2px 4px #000; font-size: 20px; z-index: 10; text-align: right; }
        
        /* æ’è¡Œæ¦œæ¨£å¼ */
        #leaderboard-box { 
            font-size: 14px; margin-top: 8px; background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px;
            text-shadow: 1px 1px 1px rgba(0,0,0,1); text-align: left;
        }
        .rank-row { margin-bottom: 3px; display: block; }
        .rank-gold { color: #FFD700; font-weight: bold; }
        .rank-silver { color: #C0C0C0; font-weight: bold; }
        .rank-bronze { color: #CD7F32; font-weight: bold; }

        #combo-box { font-size: 24px; color: #FF4444; font-weight: bold; display: none; text-shadow: 2px 2px 0 #FFF; margin-top: 5px; animation: pulse 0.5s infinite alternate; text-align: right; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
        
        #msg-container { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; width: 90%; z-index: 20; }
        #msg { color: #FFD700; font-size: 32px; font-weight: bold; text-shadow: 3px 3px 0 #000; margin-bottom: 20px; }
        
        #record-modal {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9); border: 3px solid gold; border-radius: 15px;
            padding: 25px; text-align: center; display: none; z-index: 100; width: 85%;
            box-shadow: 0 0 25px gold;
            pointer-events: auto; 
        }
        #record-modal h2 { color: #FFD700; margin: 0 0 15px 0; font-size: 28px; }
        #record-modal p { color: white; margin: 10px 0; font-size: 18px; }
        
        #playerNameInput {
            font-size: 24px; padding: 10px; width: 80%; text-align: center;
            border-radius: 8px; border: 2px solid #FFD700; margin-bottom: 20px;
            background: #fff; color: #000;
            touch-action: manipulation; user-select: text; -webkit-user-select: text;
        }

        .game-btn { background: linear-gradient(#FFB74D, #FF9800); color: white; border: none; padding: 12px 30px; font-size: 20px; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #E65100; font-weight: bold; touch-action: manipulation; }
        .small-btn { padding: 10px 25px; font-size: 18px; margin-top: 5px; }

        .floating-score { position: absolute; color: #FFF; font-weight: bold; font-size: 24px; text-shadow: 2px 2px 0 #000; pointer-events: none; animation: floatUp 1s ease-out forwards; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

<div id="ranch-story">
    <b>å²¡è¯ç‰§å ´</b><br>
    å‰µç«‹æ–¼æ°‘åœ‹59å¹´ï¼Œå¾å…©é ­ä¹³ç‰›èµ·å®¶ï¼Œè‡³ä»Šé£¼é¤Šç´„300é ­ä¹³ç‰›ã€‚
    æ°‘åœ‹94å¹´æˆç«‹é®®ä¹³é–€å¸‚ï¼Œæä¾›ç²¾é¸é®®ä¹³è£½å“ã€‚
</div>

<div id="ui">
    ğŸ† é—œå¡: <span id="lv">1</span> / 6 <br>
    ğŸ’° åˆ†æ•¸: <span id="score">0</span>
    <div id="combo-box">ğŸ”¥ Combo x<span id="comboCount">0</span></div>
    
    <div id="leaderboard-box">
        <span class="rank-row rank-gold">ğŸ¥‡ <span id="r1Name">è¼‰å…¥ä¸­...</span> : <span id="r1Score">---</span></span>
        <span class="rank-row rank-silver">ğŸ¥ˆ <span id="r2Name">---</span> : <span id="r2Score">---</span></span>
        <span class="rank-row rank-bronze">ğŸ¥‰ <span id="r3Name">---</span> : <span id="r3Score">---</span></span>
    </div>
</div>

<div id="msg-container">
    <div id="msg"></div>
    <button id="actionBtn" class="game-btn" onclick="handleBtnClick()"></button>
</div>

<div id="record-modal">
    <h2 id="modalTitle">ğŸ‰ æ¦®ç™»æ’è¡Œæ¦œï¼</h2>
    <p id="modalDesc">æ‚¨æ“ é€²äº†å…¨çƒå‰ä¸‰åï¼</p>
    <p>è«‹ç•™ä¸‹å¤§åï¼š</p>
    <input type="text" id="playerNameInput" maxlength="8" placeholder="é»æ“Šè¼¸å…¥åå­—" onclick="this.focus()">
    <br>
    <button class="game-btn small-btn" onclick="submitRecord()">ç™»éŒ„æ¦®è€€</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
// =========================================================================
// ğŸ”§ éŠæˆ²åƒæ•¸èª¿æ ¡å€ (GAME CONFIG) - ä¿®æ”¹é€™è£¡å³å¯èª¿æ•´æ‰‹æ„Ÿ
// =========================================================================
const GAME_CONFIG = {
    cow: {
        y_pos_ratio: 0.48,    // ç‰›çš„å‚ç›´ä½ç½® (0~1)ï¼Œ0.65 ä»£è¡¨åœ¨ç•«é¢ 65% é«˜åº¦ (æŸæ²¹è·¯)
        width_base: 135,      // ç‰›çš„åŸºç¤å¯¬åº¦ (LV1 çš„å¤§å°)
        width_growth: 18,     // æ¯å‡ä¸€ç´šï¼Œç‰›è®Šå¯¬å¤šå°‘
        scale: 0.75,          // æ•´é«”ç¸®æ”¾æ¯”ä¾‹
        speed_base: 3,        // åŸºç¤è·‘é€Ÿ (æ•¸å­—è¶Šå¤§è·‘è¶Šå¿«)
        speed_growth: 1.7,    // æ¯ç´šå¢åŠ çš„é€Ÿåº¦
        struggle_base: 0.3,   // åŸºç¤æŠµæŠ—åŠ› (æ•¸å­—è¶Šå¤§è¶Šé›£æ‹‰)
        struggle_growth: 0.3 // æ¯ç´šå¢åŠ çš„æŠµæŠ—åŠ›
    },
    rope: {
        target_y_ratio: 0.48  // ç¹©ç´¢ç„æº–çš„é«˜åº¦ (å»ºè­°è·Ÿç‰›çš„ä½ç½® y_pos_ratio ä¸€æ¨£)
    }
};
// =========================================================================

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBQr_3o913vgaWUg4PAuequLEVE1mZFS7M",
  authDomain: "cowgame-48dd8.firebaseapp.com",
  databaseURL: "https://cowgame-48dd8-default-rtdb.firebaseio.com",
  projectId: "cowgame-48dd8",
  storageBucket: "cowgame-48dd8.firebasestorage.app",
  messagingSenderId: "957972615393",
  appId: "1:957972615393:web:14fd2ebb956a6c48ade7a0",
  measurementId: "G-M11PJ7Z2T7"
};

// --- åˆå§‹åŒ– Firebase ---
let dbRef; 
try {
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    dbRef = database.ref('global_leaderboard_v3'); 
    console.log("å·²é€£æ¥è‡³é›²ç«¯è³‡æ–™åº« (ä¸‰é›„ç‰ˆ)");
} catch (e) {
    console.error("Firebase é€£ç·šå¤±æ•—:", e);
}

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lvDisp = document.getElementById('lv'), scoreDisp = document.getElementById('score');
const msgContainer = document.getElementById('msg-container'), msgDisp = document.getElementById('msg');
const actionBtn = document.getElementById('actionBtn');
const recordModal = document.getElementById('record-modal');
const modalTitle = document.getElementById('modalTitle');
const modalDesc = document.getElementById('modalDesc');
const nameInput = document.getElementById('playerNameInput');
const comboBox = document.getElementById('combo-box');
const comboCountDisp = document.getElementById('comboCount');

const r1NameDisp = document.getElementById('r1Name'), r1ScoreDisp = document.getElementById('r1Score');
const r2NameDisp = document.getElementById('r2Name'), r2ScoreDisp = document.getElementById('r2Score');
const r3NameDisp = document.getElementById('r3Name'), r3ScoreDisp = document.getElementById('r3Score');

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

const rawBase = `https://raw.githubusercontent.com/cposram/cow/main/`;
const imgAssets = {
    bg: new Image(), lasso: new Image(), cowNormal: new Image(), 
    cowGold: new Image(), cowDiamond: new Image(), cowGalaxy: new Image(), 
    cowLegendary: new Image(), hero: new Image()
};
imgAssets.bg.src = rawBase + 'game_bg.png'; 
imgAssets.lasso.src = rawBase + 'lasso_loop.png';
imgAssets.cowNormal.src = rawBase + 'cow_normal.png';
imgAssets.cowGold.src = rawBase + 'cow_gold.png';
imgAssets.cowDiamond.src = rawBase + 'cow_diamond.png';
imgAssets.cowGalaxy.src = rawBase + 'cow_galaxy.png';
imgAssets.cowLegendary.src = rawBase + 'cow_legendary.png';
imgAssets.hero.src = rawBase + 'cowboy_hero.png';

let level = 1, score = 0, gameState = 'RUNNING', pullProgress = 0, frameCount = 0;
let lasso = { y: 0, active: false, speed: 22 };
let levelStartTime = 0;
let missCount = 0;
let precisionScore = 0;
let combo = 0; 

let leaderboard = [
    { name: 'Benson', score: 1000 },
    { name: 'Amy', score: 500 },
    { name: 'Tom', score: 300 }
];

if (dbRef) {
    dbRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && Array.isArray(data)) {
            leaderboard = data;
        } else {
            dbRef.set(leaderboard);
        }
        updateLeaderboardUI();
    });
} else {
    const localData = localStorage.getItem('cow_leaderboard_v3');
    if (localData) leaderboard = JSON.parse(localData);
    updateLeaderboardUI();
}

function updateLeaderboardUI() {
    if (!leaderboard[0]) leaderboard[0] = { name: '---', score: 0 };
    if (!leaderboard[1]) leaderboard[1] = { name: '---', score: 0 };
    if (!leaderboard[2]) leaderboard[2] = { name: '---', score: 0 };

    r1NameDisp.innerText = leaderboard[0].name; r1ScoreDisp.innerText = leaderboard[0].score;
    r2NameDisp.innerText = leaderboard[1].name; r2ScoreDisp.innerText = leaderboard[1].score;
    r3NameDisp.innerText = leaderboard[2].name; r3ScoreDisp.innerText = leaderboard[2].score;
}

function updateComboUI() {
    if (combo > 1) {
        comboBox.style.display = 'block';
        comboCountDisp.innerText = combo;
    } else {
        comboBox.style.display = 'none';
    }
}

class Cow {
    constructor(lv) {
        this.lv = lv;
        const imgs = [imgAssets.cowNormal, imgAssets.cowNormal, imgAssets.cowGold, imgAssets.cowDiamond, imgAssets.cowGalaxy, imgAssets.cowLegendary];
        this.img = imgs[lv-1] || imgs[0];
        
        // ã€ä½¿ç”¨è¨­å®šæª”åƒæ•¸ã€‘
        this.baseWidth = (GAME_CONFIG.cow.width_base + (lv * GAME_CONFIG.cow.width_growth)) * GAME_CONFIG.cow.scale;
        this.width = this.baseWidth; 
        this.height = this.width * 0.75;
        this.baseY = canvas.height * GAME_CONFIG.cow.y_pos_ratio;  
        this.y = this.baseY;
        
        this.x = -200; 
        this.speed = (GAME_CONFIG.cow.speed_base + lv * GAME_CONFIG.cow.speed_growth); 
        this.strugglePower = GAME_CONFIG.cow.struggle_base + (lv * GAME_CONFIG.cow.struggle_growth); 
        this.reelingSpeed = 0;
    }
    update() {
        if (gameState === 'RUNNING') {
            this.x += this.speed;
        } else if (gameState === 'CATCHING') {
            this.x += (Math.random()-0.5) * 5; 
            this.y = this.baseY + (Math.random()-0.5) * 3;
        } else if (gameState === 'REELING') {
            const targetCenterX = canvas.width / 2 - this.width / 2;
            this.x += (targetCenterX - this.x) * 0.05;
            this.reelingSpeed += 0.5; 
            this.y += (4 + this.reelingSpeed); 
            const scaleFactor = 1 + (this.y - this.baseY) * 0.0015;
            this.width = this.baseWidth * scaleFactor;
            this.height = this.width * 0.75;
            if (this.reelingSpeed > 20) this.reelingSpeed = 20; 
        }
    }
    draw() { if (this.img.complete) ctx.drawImage(this.img, this.x, this.y, this.width, this.height); }
}

let currentCow = new Cow(1);

function initLevel(nextLevel) {
    level = nextLevel; 
    lvDisp.innerText = level;
    levelStartTime = Date.now();
    missCount = 0;
    precisionScore = 0;
    currentCow = new Cow(level); 
    gameState = 'RUNNING';
    msgContainer.style.display = 'none'; 
    resetLasso();
    updateComboUI();
}

function resetLasso() { 
    lasso.active = false; 
    lasso.y = canvas.height; 
}

function drawBG() {
    if (imgAssets.bg.complete && imgAssets.bg.naturalWidth !== 0) {
        const scale = Math.max(canvas.width / imgAssets.bg.naturalWidth, canvas.height / imgAssets.bg.naturalHeight);
        const w = imgAssets.bg.naturalWidth * scale;
        const h = imgAssets.bg.naturalHeight * scale;
        const x = (canvas.width - w) / 2;
        const y = (canvas.height - h) * 0.8; 
        ctx.drawImage(imgAssets.bg, x, y, w, h);
    } else {
        ctx.fillStyle = '#87CEEB'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
}

function gameLoop() {
    frameCount++;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (gameState === 'VICTORY') {
        drawVictoryScene();
    } else {
        drawBG();
        currentCow.update(); currentCow.draw();
        
        if (gameState === 'RUNNING' && currentCow.x > canvas.width + 200) {
            currentCow = new Cow(level);
        }
        
        if (lasso.active && gameState === 'RUNNING') {
            lasso.y -= lasso.speed; 
            
            const startY = canvas.height;
            // ã€ä½¿ç”¨è¨­å®šæª”åƒæ•¸ã€‘
            const endY = canvas.height * GAME_CONFIG.rope.target_y_ratio;  
            
            const distRatio = Math.max(0, (lasso.y - endY) / (startY - endY)); 
            const lassoSize = 90 * (0.35 + 0.65 * distRatio);

            if (imgAssets.lasso.complete) ctx.drawImage(imgAssets.lasso, canvas.width/2 - lassoSize/2, lasso.y - lassoSize/2, lassoSize, lassoSize);
            
            let cowCY = currentCow.y + currentCow.height/2;
            let cowCX = currentCow.x + currentCow.width/2;

            if (Math.abs(lasso.y - cowCY) < 50 && Math.abs(canvas.width/2 - cowCX) < 60) {
                let dist = Math.sqrt(Math.pow(lasso.y - cowCY, 2) + Math.pow(canvas.width/2 - cowCX, 2));
                let maxDist = 60; 
                let accuracy = Math.max(0, (maxDist - dist) / maxDist); 
                precisionScore = Math.floor(accuracy * 50);
                gameState = 'CATCHING'; pullProgress = 50;
            }
            
            if (lasso.y < cowCY - 80) {
                if (combo > 0) showFloatingText("Combo Break!", canvas.width/2, canvas.height/2, '#FF4444');
                combo = 0;
                updateComboUI();
                missCount++; 
                showFloatingText("Miss!", canvas.width/2, canvas.height/2, '#FF4444');
                resetLasso();
            }
        }
        
        if (gameState === 'CATCHING') {
            pullProgress -= currentCow.strugglePower;
            const handX = canvas.width/2; 
            const handY = canvas.height;
            const cowNeckX = currentCow.x + currentCow.width * 0.3;
            const cowNeckY = currentCow.y + currentCow.height * 0.4;
            ctx.beginPath(); ctx.moveTo(handX, handY); ctx.lineTo(cowNeckX, cowNeckY);
            ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 2 + (pullProgress/100)*2; ctx.stroke();
            drawBar();
            if (pullProgress <= 0) failCatch();
            else if (pullProgress >= 100) gameState = 'REELING';
        }
        
        if (gameState === 'REELING') {
            const handX = canvas.width/2; 
            const handY = canvas.height;
            const cowNeckX = currentCow.x + currentCow.width * 0.35;
            const cowNeckY = currentCow.y + currentCow.height * 0.5;
            ctx.beginPath(); ctx.moveTo(handX, handY); ctx.lineTo(cowNeckX, cowNeckY);
            ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 4 + (frameCount % 5) * 0.5; ctx.stroke();
            if (currentCow.y > canvas.height * 0.7) successCatch();
        }
    }
    requestAnimationFrame(gameLoop);
}

function drawVictoryScene() {
    drawBG();
    for(let i=0; i<25; i++) {
        ctx.fillStyle = ['#FFD700', '#FFF', '#FFA500'][i%3];
        ctx.beginPath();
        let x = (frameCount*4 + i*90) % canvas.width;
        let y = (frameCount*2 + i*50) % canvas.height;
        ctx.arc(x, y, 5, 0, Math.PI*2);
        ctx.fill();
    }
    const padding = 10;
    const heroW = 90, heroH = 120;
    const heroX = padding;
    const heroY = canvas.height * 0.85 - heroH; 
    const allCows = [imgAssets.cowNormal, imgAssets.cowNormal, imgAssets.cowGold, imgAssets.cowDiamond, imgAssets.cowGalaxy, imgAssets.cowLegendary];
    const backRowCows = allCows.slice(0, 3);
    const frontRowCows = allCows.slice(3, 6);
    const startX = heroX + heroW * 0.5;
    const availableW = canvas.width - startX - padding;
    const stepX = availableW / 3; 

    backRowCows.forEach((img, i) => {
        if (!img.complete) return;
        const scale = Math.min(1.0, canvas.width / 500) * 0.9;
        const w = (80 + i*5) * scale;
        const h = w * 0.75;
        const x = startX + (i * stepX) + (stepX/2); 
        const y = canvas.height * 0.78 - h + Math.sin(frameCount*0.05 + i)*5; 
        ctx.drawImage(img, x, y, w, h);
    });

    if (imgAssets.hero.complete) ctx.drawImage(imgAssets.hero, heroX, heroY, heroW, heroH);

    frontRowCows.forEach((img, i) => {
        if (!img.complete) return;
        const scale = Math.min(1.2, canvas.width / 450) * 1.1;
        const w = (100 + i*15) * scale;
        const h = w * 0.75;
        const x = startX + (i * stepX) + 20; 
        const y = canvas.height * 0.92 - h + Math.sin(frameCount*0.05 + i + 3)*8; 
        ctx.beginPath();
        ctx.moveTo(heroX + heroW*0.8, heroY + heroH*0.6); 
        ctx.quadraticCurveTo(x, y + h/2, x + 10, y + h*0.4); 
        ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 2; ctx.stroke();
        ctx.drawImage(img, x, y, w, h);
    });
}

function drawBar() {
    const w = canvas.width * 0.7;
    ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(canvas.width/2 - w/2, 100, w, 20);
    ctx.fillStyle = pullProgress > 30 ? '#0f0' : '#f00';
    ctx.fillRect(canvas.width/2 - w/2, 100, (pullProgress/100)*w, 20);
}

function showFloatingText(text, x, y, color) {
    const el = document.createElement('div');
    el.className = 'floating-score';
    el.innerText = text;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.color = color || '#FFF';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1000);
}

function successCatch() {
    combo++;
    updateComboUI();

    let timeTaken = (Date.now() - levelStartTime) / 1000;
    let speedBonus = Math.max(0, Math.floor(50 - timeTaken * 2));
    let penalty = missCount * 20;
    let baseScore = (level * 100) + precisionScore + speedBonus - penalty;
    if (baseScore < 50) baseScore = 50; 

    let comboMultiplier = 1 + (combo - 1) * 0.2; 
    let levelScore = Math.floor(baseScore * comboMultiplier);

    score += levelScore; 
    scoreDisp.innerText = score;
    
    let bonusText = `+${levelScore}`;
    if (combo > 1) bonusText += ` (Combo x${comboMultiplier.toFixed(1)}!)`;
    
    showFloatingText(bonusText, canvas.width/2 - 50, canvas.height/2 - 50, '#FFD700');

    if (level < 6) { 
        gameState = 'SUCCESS'; 
        showMsg(`æ•ç²æˆåŠŸï¼<br><span style="font-size:18px">${bonusText}</span>`, ""); 
        setTimeout(() => initLevel(level+1), 2000); 
    } else { 
        if (score >= leaderboard[2].score) {
            gameState = 'VICTORY';
            msgContainer.style.display = 'none';
            recordModal.style.display = 'block';
            
            if (score >= leaderboard[0].score) {
                modalTitle.innerText = "ğŸ‰ åˆ·æ–°å† è»ç´€éŒ„ï¼";
                modalDesc.innerText = "å¤ªç¥äº†ï¼æ‚¨æ˜¯æ–°çš„ä¸–ç•Œç¬¬ä¸€ï¼";
            } else if (score >= leaderboard[1].score) {
                modalTitle.innerText = "ğŸ‰ æ¦®ç™»äºè»ï¼";
                modalDesc.innerText = "æ­å–œï¼æ‚¨æ“ é€²äº†ä¸–ç•Œç¬¬äºŒåï¼";
            } else {
                modalTitle.innerText = "ğŸ‰ ç²å¾—å­£è»ï¼";
                modalDesc.innerText = "ä¸éŒ¯å–”ï¼æ‚¨æ˜¯ä¸–ç•Œç¬¬ä¸‰å¼·ï¼";
            }
            
            nameInput.focus();
        } else {
            gameState = 'VICTORY'; 
            showMsg("ğŸ‰ å‚³èªªé”æˆï¼<br>å¯¶è²ç‰›å…¨éƒ¨æ”¶è—æˆåŠŸï¼", "å†ç©ä¸€æ¬¡"); 
        }
    }
}

function submitRecord() {
    let name = nameInput.value.trim();
    if (!name) name = "ç¥ç§˜ç‰§å ´ä¸»";
    
    leaderboard.push({ name: name, score: score });
    leaderboard.sort((a, b) => b.score - a.score);
    leaderboard = leaderboard.slice(0, 3);
    
    if (dbRef) {
        dbRef.set(leaderboard);
    }
    
    localStorage.setItem('cow_leaderboard_v3', JSON.stringify(leaderboard));
    
    updateLeaderboardUI();
    recordModal.style.display = 'none';
    showMsg(`ğŸ‰ æ¦œå–®æ›´æ–°å®Œæˆï¼<br>åˆ†æ•¸ï¼š${score}`, "å†ç©ä¸€æ¬¡");
}

function failCatch() { 
    combo = 0; 
    updateComboUI();
    gameState = 'FAIL'; 
    showMsg("é€ƒè·‘äº†...", "é‡è©¦"); 
}

function showMsg(t, b) { msgDisp.innerHTML = t; actionBtn.innerText = b; actionBtn.style.display = b ? "inline-block" : "none"; msgContainer.style.display = "block"; }

function handleBtnClick() { if (gameState === 'FAIL' || gameState === 'VICTORY') { score = 0; combo = 0; initLevel(1); } }

function handleInput(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
    if (gameState === 'RUNNING' && !lasso.active) lasso.active = true;
    else if (gameState === 'CATCHING') pullProgress += 15;
}

canvas.addEventListener('touchstart', handleInput, {passive: false});
canvas.addEventListener('mousedown', (e) => { if(e.button===0) handleInput(e); });
nameInput.addEventListener('touchstart', (e) => { e.stopPropagation(); nameInput.focus(); });

initLevel(1); gameLoop();
</script>
</body>
</html>
